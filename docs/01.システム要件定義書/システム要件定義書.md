# システム要件定義書

## 1. システム概要

**Boxel Editor** は、Vite/React/Electron/TypeScript/Three.jsを用いた3Dボクセルベースのオブジェクト作成・編集アプリケーションである。
環境構築には **@quick-start/electron** を用いる。

## 2. 基本機能要件

### 2.1 3Dオブジェクト管理

- 起動時に立方体/直方体を構成するボクセルの個数をX軸（上限50個）、Y軸（上限50個）、Z軸（上限50個）で指定する
- **オブジェクト構成**: 8つの頂点からなるボクセルを基本単位とする
- **初期オブジェクト**: 起動時に入力されたX×Y×Zの値からボクセルからなる立方体/直方体を初期オブジェクトとして生成
  - グリッドサイズ例：X=32, Y=32, Z=32の場合、32×32×32個のボクセルで構成された立方体を生成
- **原点設定**: 座標(0, 0, 0)が初期オブジェクトのX-Z平面中心となり、底面がy=0に固定される
- **頂点統合**: 同一座標に複数の頂点が存在する場合、gltf出力時に自動的に統合される
  - gltf出力時に、外部に露出しない頂点は削除される
  - ボクセルメッシュの重複頂点を排除
  - メモリ効率化と頂点管理の簡素化を実現
- 詳細は[3Dオブジェクト仕様書](../03.システム仕様書/3Dオブジェクト仕様書.md)を参照

### 2.2 複数オブジェクト配置

**※ 将来実装予定**

- **メインオブジェクト**: 起動時に指定したサイズの立方体/直方体が編集対象となる
- **隣接オブジェクト**: 作成済みの立方体/直方体をファイルから読み込み、メインオブジェクトに隣接して配置可能（将来実装）
- **配置方法**: 隣接オブジェクトはメインオブジェクトの6方向（上下左右前後）に隣接配置可能（将来実装）

### 2.3 頂点表示

- 画面上に3Dオブジェクトの頂点を表示する
- シェーダーで頂点を青色でハイライト表示
- 外側（周辺）も視覚的にハイライトされる
- **強調表示**: ボクセルを選択時、頂点位置は実際のサイズより大きく表示される
- **頂点数表示**: 画面上またはUIパネルに現在の頂点総数を表示（メインオブジェクトのみカウント）

### 2.4 材質・着色システム

- **着色対象**: ボクセル面（ポリゴン単位）に着色可能
- **インターフェース**: 独自の着色インターフェースを実装
  - 頂点カラーは使用しない（面ごとの一貫性を保証）
  - ボクセル面ごとに統一された色情報を管理
- **カラー永続化**: カスタムカラーはアプリケーション終了後も自動保存される
- **カラー不変性**: 設定カラーは操作以外では永続的に保持される

### 2.5 カラーパレット機能

- 独自実装によるカラーパレット機能を備える
- ユーザーが直感的に色を選択・管理可能
- 外部ライブラリに依存しない自作実装

## 3. ユーザーインタラクション

### 3.1 面操作

#### 選択操作
- **左クリック**: ボクセル面を選択

#### 作成操作
- **Shift + N キー**: 選択したボクセル面に対し、その面の法線方向にボクセルを作成

#### 削除操作
- **Alt + Backspace キー**: 選択したボクセルを削除

### 3.2 色操作
- **色パレットから選択**: 選択したボクセル面を指定した色で着色
- **Alt + C キー**: 色を適用（選択面に現在の選択色を適用）

### 3.3 アンドゥ・リドゥ機能
- **アンドゥ**: Command + Z（Mac）/ Ctrl + Z（Windows）で前の操作に戻す
- **リドゥ**: Command + Shift + Z（Mac）/ Ctrl + Shift + Z（Windows）で次の操作に進む
- 操作履歴は以下の変更を記録する
  - ボクセルの追加・削除
  - 面の着色
  - カメラ操作

## 4. カメラ設定

### 4.1 カメラの初期位置・姿勢
- **初期位置**: (0, 0, 20)
- **注視点**: (0, gridSize.y/2, 0)
- **初期方向**: Z軸上からオブジェクト中央方向を向く

### 4.2 カメラ回転操作
- **W キー**: ローカル座標系の上方向へ回転（ローカルY軸周り）
- **S キー**: ローカル座標系の下方向へ回転（ローカルY軸周り）
- **A キー**: グローバルY軸周りで反時計回転
- **D キー**: グローバルY軸周りで時計回転

### 4.3 カメラパン操作
- **↑ 矢印キー**: カメラ相対の上方向へ移動
- **↓ 矢印キー**: カメラ相対の下方向へ移動
- **← 矢印キー**: カメラ相対の左方向へ移動
- **→ 矢印キー**: カメラ相対の右方向へ移動

### 4.4 ズーム操作
- **Q キー**: ズームイン（カメラを前方へ移動）
- **Shift + Q キー**: ズームアウト（カメラを後方へ移動）

## 5. UI・表示要件

### 5.1 左サイドバー - カラーパレット

**実装状況**: ✅ 完全実装

画面左に固定幅（280px）のカラーパレットサイドバーを配置：

1. **カラーピッカー**
   - ネイティブカラーピッカー（HTML color input）
   - 現在色のプレビュー表示
   - HEX値表示（#RRGGBB）
   - カラー名入力フィールド
   - 「保存」ボタンで登録済みカラーに追加

2. **プリセットカラー**（9色固定）
   - Red, Green, Blue, Yellow, Cyan, Magenta, White, Black, Gray
   - 3列グリッド表示
   - クリックで即座に選択

3. **登録済みカラー**（最大32個）
   - ユーザーが保存したカラーを一覧表示
   - 4列グリッド表示
   - 各スウォッチに削除ボタン（✕）
   - カラー名をラベル表示
   - ローカルストレージで永続化
   - 上限32個に達した場合、保存ボタンが無効化

### 5.2 メインキャンバス

- 左サイドバーの右隣に 3D シーン
- 画面領域はサイドバーを除いた全体

### 5.3 ステータスバー表示
- グリッドサイズ（X × Y × Z）の表示
- ボクセル数の表示
- 頂点数の表示

### 5.4 ハイライト表示
- **マウスホバー**: 選択対象のボクセル面を青色でハイライト
- **クリック選択**: 選択されたボクセル面を黄色でハイライト
- **パレット選択**: 現在選択されている色のパレットボタンに赤色ボーダーを表示

## 6. ファイル機能

### 6.1 形式

#### gltf形式
- 最終出力フォーマット
- 外部アプリケーションとの互換性確保

#### glw形式（作業進捗ファイル）※ 将来実装予定
- 作業中断・再開時の完全な状態復元が可能
- メタデータ内に設定済み最大グリッド数を記載

### 6.2 保存・読み込み

- **カスタムカラー自動保存**: ローカルストレージで実装（✅ 完全実装）
- **glw読み込み**: 前回の作業終了時と完全に同じ状況を再現予定（※ 将来実装）

## 7. モーション機能

- 生成されたファイルは**フレーム単位でのモーション**実行が可能（将来実装）
- アニメーション機能に対応予定

## 8. 技術スタック

- **フレームワーク**: React 18.3.x
- **バンドラー**: Vite 5.4.x
- **デスクトップ化**: Electron 31.0.2
- **言語**: TypeScript 5.x
- **3Dグラフィックス**: Three.js 0.182.0
- **シェーダー**: GLSL（カスタムシェーダー対応）

## 8. 非機能要件

### 8.1 パフォーマンス

- 最大50ボクセルでのリアルタイム編集
- 60FPS以上の描画フレームレート

### 8.2 ユーザビリティ

- 直感的な3D操作インターフェース
- 視覚的フィードバック（ハイライト・選択状態の明確化）

### 8.3 永続性

- ローカルストレージへのカラー設定保存
- ファイルシステムへのプロジェクト保存