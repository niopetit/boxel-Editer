# ファイル仕様書

## 1. 概要

Boxel Editorは以下のファイル形式をサポート：
- **glw形式**: 作業進捗の完全な状態復元用（内部フォーマット）✅ 実装完了
- **gltf形式**: 最終出力フォーマット（外部アプリケーション互換）✅ 実装完了
- **カラーパレット**: ローカルストレージで永続化 ✅ 実装完了

## 2. glw形式（作業進捗ファイル）

### 2.1 形式概要
- **ファイル拡張子**: `.glw`
- **MIME タイプ**: `application/json`
- **ベース形式**: JSON
- **状態**: ✅ 実装完了
- **保存先**: ユーザーが指定したディレクトリ

### 2.2 ファイル構造

```json
{
  "version": "1.0.0",
  "metadata": {
    "version": "1.0.0",
    "createdAt": "2026-01-13T10:30:00Z",
    "updatedAt": "2026-01-13T10:30:00Z",
    "gridSizeX": 32,
    "gridSizeY": 32,
    "gridSizeZ": 32,
    "maxGridX": 50,
    "maxGridY": 50,
    "maxGrid": 50
  },
  "mainObject": {
    "gridSizeX": 32,
    "gridSizeY": 32,
    "gridSizeZ": 32,
    "voxels": [ /* ボクセルデータ配列 */ ],
    "colors": { /* 面着色情報 */ }
  },
  "adjacentObjects": [],
  "colorPalette": [ /* カラーパレット */ ],
  "undoRedoHistory": [ /* 操作履歴 */ ]
}
```

### 2.3 詳細フィールド仕様

#### 2.3.1 metadata オブジェクト
| フィールド | 型 | 説明 |
|------------|-----|------|
| version | string | ファイル形式のバージョン |
| createdAt | string | ファイル作成日時（ISO 8601形式） |
| updatedAt | string | 最終更新日時（ISO 8601形式） |
| gridSizeX | number | X軸のグリッド数 |
| gridSizeY | number | Y軸のグリッド数 |
| gridSizeZ | number | Z軸のグリッド数 |
| maxGridX | number | X軸の最大グリッド数 |
| maxGridY | number | Y軸の最大グリッド数 |
| maxGrid | number | グリッドの設定最大値 |

#### 2.3.2 mainObject オブジェクト
| フィールド | 型 | 説明 |
|------------|-----|------|
| gridSizeX | number | X軸のグリッド数 |
| gridSizeY | number | Y軸のグリッド数 |
| gridSizeZ | number | Z軸のグリッド数 |
| voxels | array | ボクセルデータの配列 |
| colors | object | 面着色情報 |

#### 2.3.3 voxel オブジェクト構造
```json
{
  "id": "voxel_0",
  "position": { "x": 0, "y": 0, "z": 0 },
  "vertices": [
    { "id": "v_0", "x": 0, "y": 1, "z": 0 },
    { "id": "v_1", "x": 1, "y": 1, "z": 0 },
    // ... 8頂点
  ],
  "faces": [
    {
      "id": "face_0",
      "vertexIds": ["v_0", "v_1", "v_5", "v_4"],
      "normal": "y+",
      "color": "#808080"
    },
    // ... 6面
  ]
}
```

### 2.4 保存処理

```typescript
const handleSave = async (): Promise<void> => {
  if (!voxelMeshRef.current) return
  
  // ファイル保存ダイアログを表示
  const defaultFileName = `boxel_project_${new Date().toISOString().slice(0, 10)}_${new Date().getHours().toString().padStart(2, '0')}${new Date().getMinutes().toString().padStart(2, '0')}.glw`
  const result = await window.api.showSaveDialog(defaultFileName)
  
  if (result.canceled || !result.filePath) return

  const glwFile = FileManager.createGlwTemplate(gridSize.x, gridSize.y)
  glwFile.mainObject.voxels = Array.from(voxelMeshRef.current.getVoxels().values())
  
  const content = JSON.stringify(glwFile, null, 2)
  await window.api.saveProjectFile(result.filePath, content)
}
```

### 2.5 読み込み処理

```typescript
const handleLoad = async (): Promise<void> => {
  // ファイル開くダイアログを表示
  const result = await window.api.showOpenDialog()
  if (result.canceled || result.filePaths.length === 0) return

  const filePath = result.filePaths[0]
  const content = await window.api.loadProjectFile(filePath)
  const glwFile = JSON.parse(content)

  // ボクセルメッシュをリセット
  meshGroupRef.current.clear()
  voxelMeshRef.current.clear()

  // ボクセルを復元
  if (glwFile.mainObject && glwFile.mainObject.voxels) {
    glwFile.mainObject.voxels.forEach((voxelData: any) => {
      voxelMeshRef.current?.restoreVoxel(voxelData.id, voxelData)
    })
  }

  // メッシュを再生成
  updateVoxelMeshRef.current?.()
}
```

## 3. gltf形式（エクスポート）

### 3.1 形式概要
- **ファイル拡張子**: `.gltf`
- **MIME タイプ**: `model/gltf+json`
- **標準**: glTF 2.0
- **状態**: ✅ 実装完了

### 3.2 出力内容

#### 3.2.1 メッシュ情報
- **頂点データ**: メインオブジェクトの統合メッシュ
- **頂点統合**: 同一座標上の重複頂点は自動的に排除
- **面情報**: ポリゴンインデックスと法線情報
- **外部頂点のみ**: 内部に露出しない頂点は削除される

#### 3.2.2 頂点カラー
- ボクセルの面ごとの着色情報を頂点カラーとしてエクスポート
- COLOR_0アトリビュートに格納

### 3.3 GLTF構造

```json
{
  "asset": {
    "version": "2.0",
    "generator": "Boxel Editor"
  },
  "scene": 0,
  "scenes": [{ "nodes": [0] }],
  "nodes": [{
    "mesh": 0,
    "name": "BoxelMesh"
  }],
  "meshes": [{
    "primitives": [{
      "attributes": {
        "POSITION": 0,
        "NORMAL": 1,
        "COLOR_0": 2
      },
      "indices": 3
    }]
  }],
  "accessors": [ /* ... */ ],
  "bufferViews": [ /* ... */ ],
  "buffers": [{
    "uri": "data:application/octet-stream;base64,...",
    "byteLength": 12345
  }]
}
```

### 3.4 エクスポート処理

```typescript
const handleExport = async (): Promise<void> => {
  if (!voxelMeshRef.current) return

  // ファイル保存ダイアログを表示
  const defaultFileName = `boxel_${new Date().toISOString().slice(0, 10)}.gltf`
  const result = await window.api.showExportDialog(defaultFileName)
  
  if (result.canceled || !result.filePath) return

  // GLTFデータを生成（カラー情報を含める）
  const voxels = voxelMeshRef.current.getVoxels()
  const colorMap = voxelMeshRef.current.getColorMap()
  const gltfData = FileManager.createGltfData(voxels, colorMap)
  const gltfString = JSON.stringify(gltfData, null, 2)

  await window.api.saveGltfFile(result.filePath, gltfString)
}
```

### 3.5 頂点・法線計算

```typescript
// 頂点位置を収集（重複排除）
const uniquePositions: number[] = []
const positionMap = new Map<string, number>()

voxels.forEach((voxel) => {
  voxel.faces.forEach((face) => {
    face.vertexIds.forEach((vertexId) => {
      const vertex = voxel.vertices.find(v => v.id === vertexId)
      if (vertex) {
        const key = `${vertex.x},${vertex.y},${vertex.z}`
        if (!positionMap.has(key)) {
          positionMap.set(key, uniquePositions.length / 3)
          uniquePositions.push(vertex.x, vertex.y, vertex.z)
        }
      }
    })
  })
})
```

## 4. カラーパレット永続化

### 4.1 保存形式

```json
[
  {
    "id": "custom_1705036200000",
    "hex": "#FF0000",
    "name": "My Red"
  },
  {
    "id": "custom_1705036205000",
    "hex": "#0080FF",
    "name": "Custom Blue"
  }
]
```

### 4.2 保存場所

- **ローカルストレージキー**: `boxel-editor-custom-colors`
- **バックアップ**: `{userData}/config/pallet.json`（Electron経由）

### 4.3 IPC通信

```typescript
// メインプロセス
ipcMain.handle('save-palette', async (_event, colors) => {
  const configDir = join(app.getPath('userData'), 'config')
  const paletteFilePath = join(configDir, 'pallet.json')

  if (!existsSync(configDir)) {
    mkdirSync(configDir, { recursive: true })
  }

  writeFileSync(paletteFilePath, JSON.stringify(colors, null, 2), 'utf-8')
})

ipcMain.handle('load-palette', async () => {
  const paletteFilePath = join(app.getPath('userData'), 'config', 'pallet.json')
  
  if (!existsSync(paletteFilePath)) {
    return []
  }

  const data = readFileSync(paletteFilePath, 'utf-8')
  return JSON.parse(data)
})
```

## 5. IPC APIリファレンス

### 5.1 ファイル操作

| API | 説明 | パラメータ | 戻り値 |
|-----|------|------------|--------|
| showSaveDialog | 保存ダイアログ表示 | defaultPath | { filePath, canceled } |
| showOpenDialog | 開くダイアログ表示 | - | { filePaths, canceled } |
| showExportDialog | エクスポートダイアログ表示 | defaultPath | { filePath, canceled } |
| saveProjectFile | glwファイル保存 | filePath, content | void |
| loadProjectFile | glwファイル読み込み | filePath | content |
| saveGltfFile | gltfファイル保存 | filePath, content | boolean |

### 5.2 GLTF読み込み（隣接オブジェクト用）

| API | 説明 | パラメータ | 戻り値 |
|-----|------|------------|--------|
| showGltfOpenDialog | GLTF選択ダイアログ | - | { filePaths, canceled } |
| loadGltfFile | GLTFファイル読み込み | filePath | { data, extension, filePath } |

### 5.3 カラーパレット

| API | 説明 | パラメータ | 戻り値 |
|-----|------|------------|--------|
| savePalette | パレット保存 | colors | void |
| loadPalette | パレット読み込み | - | colors[] |

## 6. エラーハンドリング

### 6.1 読み込みエラー
- **ファイルが見つからない**: アラート表示「プロジェクトの読み込みに失敗しました」
- **JSONパース失敗**: コンソールエラー出力 + アラート表示

### 6.2 保存エラー
- **ディスク容量不足**: アラート表示「プロジェクトの保存に失敗しました」
- **パーミッション不足**: アラート表示「プロジェクトの保存に失敗しました」

## 7. ファイルダイアログフィルター

### 7.1 glwファイル

```typescript
filters: [
  { name: 'Boxel Project', extensions: ['glw'] },
  { name: 'All Files', extensions: ['*'] }
]
```

### 7.2 gltfエクスポート

```typescript
filters: [
  { name: 'glTF', extensions: ['gltf'] },
  { name: 'glTF Binary', extensions: ['glb'] },
  { name: 'All Files', extensions: ['*'] }
]
```

### 7.3 gltf/glbインポート（隣接オブジェクト）

```typescript
filters: [
  { name: 'glTF Files', extensions: ['gltf', 'glb'] },
  { name: 'All Files', extensions: ['*'] }
]
```

## 8. デフォルトファイル名

| 操作 | デフォルトファイル名 |
|------|----------------------|
| プロジェクト保存 | `boxel_project_YYYY-MM-DD_HHMM.glw` |
| GLTFエクスポート | `boxel_YYYY-MM-DD.gltf` |
