# ファイル仕様書

## 1. 概要

Boxel Editorは2つのファイル形式をサポートしている：
- **glw形式**: 作業進捗の完全な状態復元用（内部フォーマット）
- **gltf形式**: 最終出力フォーマット（外部アプリケーション互換）

## 2. glw形式（作業進捗ファイル）

### 2.1 形式概要
- ファイル拡張子: `.glw`
- MIME タイプ: `application/json`
- ベース形式: JSON

### 2.2 ファイル構造

```json
{
  "version": "1.0.0",
  "metadata": {
    "createdAt": "2024-01-11T10:30:00Z",
    "updatedAt": "2024-01-11T10:30:00Z",
    "gridSizeX": 32,
    "gridSizeY": 32,
    "maxGridX": 50,
    "maxGridY": 50
  },
  "mainObject": {
    "gridSizeX": 32,
    "gridSizeY": 32,
    "voxels": [ /* ボクセルデータ配列 */ ],
    "colors": { /* 面着色情報 */ }
  },
  "adjacentObjects": [ /* 隣接オブジェクト配列 */ ],
  "camera": { /* カメラ状態 */ },
  "colorPalette": [ /* カラーパレット */ ],
  "undoRedoHistory": [ /* 操作履歴 */ ]
}
```

### 2.3 詳細フィールド仕様

#### 2.3.1 metadata オブジェクト
- **version**: ファイル形式のバージョン（セマンティックバージョニング）
- **createdAt**: ファイル作成日時（ISO 8601形式）
- **updatedAt**: 最終更新日時（ISO 8601形式）
- **gridSizeX**: X軸のグリッド数（現在値）
- **gridSizeY**: Y軸のグリッド数（現在値）
- **maxGridX**: X軸の設定最大値（参照用）
- **maxGridY**: Y軸の設定最大値（参照用）

#### 2.3.2 mainObject オブジェクト
- **gridSizeX**: X軸のグリッド数
- **gridSizeY**: Y軸のグリッド数
- **voxels**: ボクセルデータの配列
  ```json
  [
    {
      "id": "voxel_0",
      "position": { "x": 0, "y": 0, "z": 0 },
      "vertices": [
        { "id": "v0", "x": 0, "y": 0, "z": 0 },
        { "id": "v1", "x": 1, "y": 0, "z": 0 },
        ...
      ],
      "faces": [
        { "vertexIds": ["v0", "v1", "v4", "v5"], "normal": "x+" },
        ...
      ]
    }
  ]
  ```
- **colors**: 面着色情報
  ```json
  {
    "voxel_0_face_0": "#FF0000",
    "voxel_0_face_1": "#00FF00",
    ...
  }
  ```

#### 2.3.3 adjacentObjects 配列
隣接オブジェクトのリスト（複数可）

```json
[
  {
    "id": "adjacent_0",
    "filePath": "/path/to/file.glw",
    "direction": "up",
    "position": { "x": 0, "y": 32, "z": 0 },
    "gridSizeX": 16,
    "gridSizeY": 16,
    "voxels": [ /* ボクセルデータ */ ],
    "colors": { /* 面着色情報 */ }
  }
]
```

**direction（配置方向）**:
- `"up"`: Y軸プラス方向（上）
- `"down"`: Y軸マイナス方向（下）
- `"left"`: X軸マイナス方向（左）
- `"right"`: X軸プラス方向（右）
- `"front"`: Z軸マイナス方向（前）
- `"back"`: Z軸プラス方向（後）

#### 2.3.4 camera オブジェクト
```json
{
  "position": { "x": 50.0, "y": 50.0, "z": 50.0 },
  "rotation": { "x": 0.5, "y": 0.5, "z": 0.0 },
  "zoom": 1.0,
  "target": { "x": 0.0, "y": 0.0, "z": 0.0 }
}
```

#### 2.3.5 colorPalette 配列
```json
[
  {
    "id": "color_0",
    "name": "Red",
    "hex": "#FF0000",
    "rgb": { "r": 255, "g": 0, "b": 0 }
  },
  {
    "id": "color_1",
    "name": "Custom Blue",
    "hex": "#0080FF",
    "rgb": { "r": 0, "g": 128, "b": 255 }
  }
]
```

#### 2.3.6 undoRedoHistory 配列
```json
[
  {
    "id": "action_0",
    "type": "addVoxel",
    "timestamp": "2024-01-11T10:30:00Z",
    "data": { /* アクション固有データ */ }
  },
  {
    "id": "action_1",
    "type": "colorFace",
    "timestamp": "2024-01-11T10:30:05Z",
    "data": { /* アクション固有データ */ }
  }
]
```

### 2.4 ファイルサイズ目安
- グリッドサイズ 32×32: 約100～500KB
- グリッドサイズ 50×50: 約200～1000KB
- 隣接オブジェクト追加時: オブジェクトごとに追加

### 2.5 保存・読み込み仕様

#### 2.5.1 自動保存
- **タイミング**: ユーザーが操作を行った後、1秒のデバウンス後に自動保存
- **保存先**: `~/.boxeleditor/autosave.glw`（または指定されたプロジェクトフォルダ）

#### 2.5.2 手動保存
- **タイミング**: ユーザーが「保存」を実行時
- **ファイル名**: ユーザーが指定

#### 2.5.3 読み込み
- **互換性**: バージョン番号で形式の互換性をチェック
- **マイグレーション**: 旧バージョンから新バージョンへのアップグレード処理を実装
- **バリデーション**: JSON スキーマで構造を検証

## 3. gltf形式（最終出力）

### 3.1 形式概要
- ファイル拡張子: `.gltf` または `.glb`
- メディアタイプ: `model/gltf+json` または `model/gltf-binary`
- 標準: glTF 2.0

### 3.2 出力内容

#### 3.2.1 メッシュ情報
- **頂点データ**: メインオブジェクトと隣接オブジェクトの統合メッシュ
- **頂点統合**: 同一座標上の重複頂点は自動的に排除
- **面情報**: ポリゴンインデックスと法線情報
- **外部頂点のみ**: 内部に露出しない頂点は削除される

#### 3.2.2 マテリアル情報
- **フェイスカラー**: ボクセルの面ごとの着色情報
- **PBR設定**: 基本的なPBRパラメータ（メタリック、ラフネス）
- **テクスチャ**: （オプション）カラーテクスチャ

#### 3.2.3 モーション情報
- **アニメーション**: フレーム単位のアニメーションデータ
- **キーフレーム**: ボクセルの変形やメッシュの変位

### 3.3 出力メタデータ
- **オーバー情報**: 作成者、作成日時、グリッドサイズなど
- **単位**: メーター単位（1ボクセル = 1m）

### 3.4 エクスポートオプション
- **フォーマット選択**: glTF（JSON + bin）または glB（バイナリ統合）
- **圧縮**: オプションで gzip圧縮

## 4. バージョン管理

### 4.1 glw形式バージョン履歴

| バージョン | 説明 | リリース日 |
| --- | --- | --- |
| 1.0.0 | 初版（基本的なボクセルと着色情報） | - |
| 1.1.0 | 隣接オブジェクト機能追加 | - |

### 4.2 マイグレーション戦略
- 旧バージョンのファイルは読み込み時に自動的に新バージョンに変換
- 変換処理は非破壊（元のデータは保持）

## 5. エラーハンドリング

### 5.1 読み込みエラー
- **ファイルが見つからない**: 「ファイルが見つかりません」メッセージ表示
- **JSONパース失敗**: 「ファイル形式が無効です」メッセージ表示
- **スキーマ不一致**: 「ファイル形式が古いか破損しています」メッセージ表示

### 5.2 保存エラー
- **ディスク容量不足**: 「ディスク容量が不足しています」メッセージ表示
- **パーミッション不足**: 「ファイルを保存できません」メッセージ表示

## 6. セキュリティ

### 6.1 入力検証
- ファイルサイズの上限チェック（最大 10MB）
- JSON スキーマによる構造検証
- 数値範囲の検証（座標、グリッドサイズなど）

### 6.2 ファイル保護
- 隣接オブジェクトのファイルパスは相対パスで保存（移植性確保）
- ユーザーデータの自動バックアップ機能

## 7. パフォーマンス

### 7.1 ファイルI/O
- **読み込み時間**: グリッド32×32 で 100ms以下
- **保存時間**: グリッド32×32 で 50ms以下

### 7.2 メモリ効率
- 効率的な JSON シリアライゼーション
- 大規模ファイルのストリーミング処理（オプション）
