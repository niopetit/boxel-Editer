# 着色システム仕様書

## 1. 概要

Boxel Editorの着色システムは、ボクセルの個々の面（フェース）に対して色を指定・管理する。面ごとの一貫した色情報を保持し、ユーザーが直感的に色を選択・変更できるUI を提供する。

## 2. 着色モデル

### 2.1 着色対象

- **粒度**: ボクセル面（ポリゴン単位）ごとに独立した色を管理
- **非対象**: 頂点カラーは使用しない（面ごとの一貫性を確保）
- **レンダリング**: 各ボクセル面は個別の Three.js Mesh として管理（MeshBasicMaterial）

### 2.2 色表現

#### 2.2.1 色データ形式

```typescript
interface FaceColor {
  hexColor: string;            // #RRGGBB 形式（例: "#FF0000"）
  baseColor?: string;          // ホバー/選択前の元の色（状態保存用）
}
```

#### 2.2.2 デフォルト色

- **初期色**: グレー（#808080）
- **推奨**: ユーザーが明示的に色を選択するまで表示される

### 2.3 色の状態管理

#### 2.3.1 色の遷移

- **通常状態**: `baseColor` に設定された色で表示
- **ホバー状態**: 青色（#0099FF）でハイライト表示
- **クリック選択**: 黄色（#FFFF00）でハイライト表示
- **パレット選択**: 赤色ボーダー（#FF0000）で UI パレットボタンをハイライト
- **色適用**: `Alt + C` で現在の選択色が適用され、baseColor が更新される

#### 2.3.2 色の永続化

- **保存方式**: メッシュの userData に baseColor を保持（React キャンバス ref 内）
- **自動更新**: 色が適用された時点で baseColor が自動更新される
- **ファイル保存**: glw/gltf形式ファイル出力時に色情報が記録される予定

## 3. カラーパレット機能

### 3.1 パレット構造

```typescript
interface ColorPalette {
  colors: PaletteColor[];
  selectedColorId?: string;
}

interface PaletteColor {
  id: string;
  name?: string;
  hex: string;
  timestamp: string;          // ISO 8601形式、使用日時
  usageCount: number;         // 使用回数
}
```

### 3.2 ユーザー追加カラー（登録済みカラー）

#### 3.2.1 追加方法（実装済み）
- UI内のカラーピッカーで色を選択
- カラー名を入力（オプション）
- 「保存」ボタンをクリック
- ローカルストレージに保存（最大100個）

#### 3.2.2 保存仕様

ローカルストレージに保存：

```typescript
const STORAGE_KEY = "boxel_editor_saved_colors";

localStorage.setItem(
  STORAGE_KEY,
  JSON.stringify(userColorPalette)
);
```

**保存内容**:
```json
[
  {
    "id": "custom_color_0",
    "hex": "#0080FF",
    "name": "My Blue"
  }
]
```

## 4. 着色操作フロー

### 4.2 着色処理の実装

```typescript
function colorFace(faceId: string, colorHex: string): void {
  // 色情報を更新
  updateFaceMaterial(faceId, colorHex);
  
  // 3D描画を更新
  render();
  
  // 使用した色をカラーヒストリーに記録
  recordColorHistory(colorHex);
  
  // アンドゥスタックに追加
  undoStack.push({
    type: "colorFace",
    faceId: faceId,
    previousColor: previousColor,
    newColor: colorHex
  });
}

function recordColorHistory(colorHex: string): void {
  // Electron ipcMain 経由で main プロセスに通知
  window.electron.ipcRenderer.send('record-color-history', colorHex);
}
```

### 4.3 複数面の着色（オプション）

- 連続した複数面を選択して一度に着色可能
- Shift + クリックで複数選択

## 5. マテリアル実装

### 5.1 Three.jsでのマテリアル設定（実装）

```typescript
// MeshBasicMaterial を使用（フラットな色表現）
const faceMaterial = new THREE.MeshBasicMaterial({
  color: new THREE.Color(hexColor),
  side: THREE.DoubleSide  // 両面レンダリング有効
});
```

**実装詳細**:
- **MeshBasicMaterial**: ライティングの影響を受けないフラットなマテリアル
- **DoubleSide**: 両面を描画（内側からも見える）
- **ハイライト**: ホバー/選択時に色を動的に変更

### 5.2 色の計算

```typescript
function hexToRgb(hex: string): { r: number; g: number; b: number } {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 128, g: 128, b: 128 }; // デフォルト: グレー
}

function rgbToHex(r: number, g: number, b: number): string {
  return "#" + [r, g, b].map(x => {
    const hex = x.toString(16);
    return hex.length === 1 ? "0" + hex : hex;
  }).join("").toUpperCase();
}
```

## 6. UI仕様

### 6.1 サイドバーレイアウト

**実装状況**: ✅ 完全実装

カラーパレットは画面左のサイドバーに配置されます：
- **幅**: 280px
- **高さ**: 画面全体（100vh）
- **背景**: ダーク（#1e1e1e から #2a2a2a へのグラデーション）
- **レイアウト**: スクロール可能な3つのセクション

#### 6.1.1 セクション構成

1. **カラーピッカー**
   - HTMLの `<input type="color">` を使用
   - 現在選択中の色をプレビュー表示
   - HEX値をテキスト表示
   - カラー名を入力して「保存」ボタンで登録

2. **登録済みカラー**（最大100個）
   - ユーザーが明示的に保存したカラーを表示
   - 4列のグリッド表示
   - 色をクリックで選択
   - 各スウォッチに削除ボタン（✕）を配置
   - カラー名をラベルで表示

### 6.2 カラースウォッチUI

- **サイズ**: アスペクト比 1:1（正方形）、4列グリッドに収まるサイズ
- **スタイル**:
  - **通常状態**: 2px透明ボーダー、ホバーで強調
  - **選択状態**: 赤色ボーダー（#FF0000, 2px）と赤グロー効果
  - **ホバー状態**: スケール1.05、シャドウ追加
  - **クリック状態**: スケール0.98（フィードバック）

### 6.3 カラーピッカー

#### 6.3.1 入力インターフェース
- **ネイティブカラーピッカー**: HTMLの `<input type="color">` を使用
- **サイズ**: 50×50px
- **プレビュー表示**: ピッカーの横に同サイズの色プレビュー

#### 6.3.2 HEX値表示
- **表示形式**: `#RRGGBB`（大文字）
- **背景**: 暗い背景（#262626）
- **フォント**: 等幅フォント（Monaco / Courier New）
- **色**: 明るい青（#4fc3f7）

### 6.4 カラー名入力

- **入力フィールド**: テキスト入力、最大20文字
- **プレースホルダー**: "色の名前（オプション）"
- **保存ボタン**:
  - **スタイル**: グラデーション背景（#667eea → #764ba2）
  - **テキスト**: 「保存」
  - **無効時**: 100個登録済みの場合は無効化（opacity: 0.5）

### 6.5 保存済みカラー（ユーザー登録カラー）の管理

#### 6.5.1 ストレージ
- **保存先**: ブラウザのローカルストレージ
- **キー**: `boxel_editor_saved_colors`
- **フォーマット**: JSON 配列
- **永続性**: アプリケーション再起動後も保存される

#### 6.5.2 削除機能
- **削除ボタン**: スウォッチの右上に赤い円形ボタン（✕）
- **表示**: ホバー時のみ表示
- **動作**: クリックで即座に削除

#### 6.5.3 上限管理
- **最大個数**: 100個
- **超過時**: 保存ボタンが無効化、アラート表示

## 7. データ永続化

### 7.1 glw形式での保存

```json
{
  "mainObject": {
    "voxels": [ /* ... */ ],
    "colors": {
      "voxel_0_face_0": "#FF0000",
      "voxel_0_face_1": "#00FF00",
      "voxel_1_face_2": "#0000FF"
    }
  }
}
```

### 7.2 ユーザー登録カラー（ローカルストレージ）

ユーザーが明示的に「保存」ボタンをクリックして登録したカラーはローカルストレージに保存される：

```typescript
// 保存
localStorage.setItem("boxel_editor_saved_colors", JSON.stringify(palette));

// 読み込み
const savedPalette = localStorage.getItem("boxel_editor_saved_colors");
const palette = savedPalette ? JSON.parse(savedPalette) : [];
```

**特性**:
- ローカルストレージ内に保存（ブラウザ/Electronレベル）
- 最大100個
- ユーザーが明示的に削除可能
- アプリケーション再起動後も保存される

## 8. パフォーマンス

### 8.1 レンダリング最適化

- **マテリアル キャッシング**: 同一色の面は同じマテリアルを共有
- **バッチ処理**: 同一マテリアルの面をまとめて描画

### 8.2 メモリ効率

最大2,500ボクセル × 6面 = 15,000面の着色情報：
- メモリ使用量：約 60KB（色情報のみ）

### 8.3 ファイルI/O最適化

- **カラーヒストリー記録**: 非同期処理（`ipcRenderer.send` で非ブロッキング）
- **ファイル読み込み**: アプリケーション起動時にメモリにロード
- **ディスク書き込み**: バッチ処理で不要な書き込みを削減

## 9. アクセシビリティ

### 9.1 カラーコントラスト

- パレット表示時のテキストは WCAG AA 準拠のコントラスト比を確保
- カラーピッカーのラベルは明確に

### 9.2 キーボード操作

- Tab キーでパレット内の色を移動可能
- Enter キーで色を選択可能

## 10. エラーハンドリング

### 10.1 入力値検証

```typescript
function validateRgbValue(value: number): number {
  if (typeof value !== "number") return 0;
  if (value < 0) return 0;
  if (value > 255) return 255;
  return Math.floor(value);
}

function validateHexColor(hex: string): string {
  const cleaned = hex.replace(/^#/, "").toUpperCase();
  if (!/^[0-9A-F]{6}$/.test(cleaned)) {
    return "#808080"; // デフォルト: グレー
  }
  return "#" + cleaned;
}
```

### 10.2 エラーメッセージ

- 無効な入力値の場合、ステータスバーに警告を表示
- 最後に有効だった色値に自動リセット
