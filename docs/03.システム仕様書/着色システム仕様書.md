# 着色システム仕様書

## 1. 概要

Boxel Editorの着色システムは、ボクセルの個々の面（フェース）に対して色を指定・管理する。面ごとの一貫した色情報を保持し、ユーザーが直感的に色を選択・変更できるUI を提供する。

## 2. 着色モデル

### 2.1 着色対象

- **粒度**: ボクセル面（ポリゴン単位）
- **非対象**: 頂点カラーは使用しない（面ごとの一貫性を確保）

### 2.2 色表現

#### 2.2.1 色データ形式

```typescript
interface FaceColor {
  faceId: string;              // ボクセル内での面ID (0-5)
  hexColor: string;            // #RRGGBB 形式（例: "#FF0000"）
  rgbColor: {
    r: number;                 // 0-255
    g: number;                 // 0-255
    b: number;                 // 0-255
  };
  alpha?: number;              // 0.0-1.0（オプション、通常は1.0）
  timestamp?: string;          // ISO 8601形式の最終更新日時
}
```

#### 2.2.2 デフォルト色

- **未着色状態**: グレー（#808080）
- **推奨**: ユーザーが明示的に色を選択するまで表示される

### 2.3 色の永続化

- **保存先**: glw形式ファイルの `colors` フィールド
- **キー形式**: `"voxelId_faceId"` （例: `"voxel_0_face_0""`）
- **自動保存**: アプリケーション終了時に自動保存

## 3. カラーパレット機能

### 3.1 パレット構造

```typescript
interface ColorPalette {
  colors: PaletteColor[];
  selectedColorId?: string;
}

interface PaletteColor {
  id: string;
  name: string;
  hex: string;
  rgb: { r: number; g: number; b: number };
  category?: string;          // （オプション）カテゴリ分類
  custom: boolean;            // true: ユーザー追加, false: プリセット
}
```

### 3.2 初期カラーセット

推奨されるプリセットカラー（カスタマイズ可能）：

| ID | 色名 | HEX | RGB |
| --- | --- | --- | --- |
| color_red | Red | #FF0000 | (255, 0, 0) |
| color_green | Green | #00FF00 | (0, 255, 0) |
| color_blue | Blue | #0000FF | (0, 0, 255) |
| color_yellow | Yellow | #FFFF00 | (255, 255, 0) |
| color_cyan | Cyan | #00FFFF | (0, 255, 255) |
| color_magenta | Magenta | #FF00FF | (255, 0, 255) |
| color_white | White | #FFFFFF | (255, 255, 255) |
| color_black | Black | #000000 | (0, 0, 0) |
| color_gray | Gray | #808080 | (128, 128, 128) |

### 3.3 ユーザー追加カラー

#### 3.3.1 追加方法
- UI内の「+」ボタンをクリック
- カラーピッカーダイアログが表示される

#### 3.3.2 カラーピッカーインターフェース
- **RGB入力**: 0～255の値を個別入力
- **HEX入力**: 6桁の16進数（例: FF0000）
- **ビジュアルピッカー**: 正方形または六角形のカラー選択パネル

#### 3.3.3 保存仕様

追加されたカラーはローカルストレージに保存：

```typescript
const STORAGE_KEY = "boxeleditor_color_palette";

localStorage.setItem(
  STORAGE_KEY,
  JSON.stringify(userColorPalette)
);
```

**保存内容**:
```json
[
  {
    "id": "custom_color_0",
    "name": "My Blue",
    "hex": "#0080FF",
    "rgb": { "r": 0, "g": 128, "b": 255 },
    "custom": true
  }
]
```

## 4. 着色操作フロー

### 4.1 面着色の基本フロー

```
1. 左クリック → 面を選択
   ↓
2. パレットから色を選択
   ↓
3. Option + 右クリック → 面に着色
   ↓
4. 面の色が即座に更新される
```

### 4.2 着色処理の実装

```typescript
function colorFace(faceId: string, colorHex: string): void {
  // 色情報を更新
  colorMap.set(faceId, {
    hexColor: colorHex,
    rgbColor: hexToRgb(colorHex),
    timestamp: new Date().toISOString()
  });
  
  // メッシュマテリアルを更新
  updateFaceMaterial(faceId, colorHex);
  
  // 3D描画を更新
  render();
  
  // アンドゥスタックに追加
  undoStack.push({
    type: "colorFace",
    faceId: faceId,
    previousColor: previousColorMap.get(faceId),
    newColor: colorHex
  });
}
```

### 4.3 複数面の着色（オプション）

- 連続した複数面を選択して一度に着色可能
- Shift + クリックで複数選択

## 5. マテリアル実装

### 5.1 Three.jsでのマテリアル設定

```typescript
interface FaceMaterial {
  color: Color;               // THREE.Color
  emissive: Color;           // 発光色（デフォルト: 黒）
  metalness: number;         // 0.0-1.0（デフォルト: 0.0）
  roughness: number;         // 0.0-1.0（デフォルト: 1.0）
}

const faceMaterial = new THREE.MeshStandardMaterial({
  color: new THREE.Color(hexColor),
  metalness: 0.0,
  roughness: 1.0,
  side: THREE.FrontSide
});
```

### 5.2 色の計算

```typescript
function hexToRgb(hex: string): { r: number; g: number; b: number } {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 128, g: 128, b: 128 }; // デフォルト: グレー
}

function rgbToHex(r: number, g: number, b: number): string {
  return "#" + [r, g, b].map(x => {
    const hex = x.toString(16);
    return hex.length === 1 ? "0" + hex : hex;
  }).join("").toUpperCase();
}
```

## 6. UI仕様

### 6.1 パレット表示

- **レイアウト**: 3列×N行のグリッド
- **スウォッチサイズ**: 48×48px（推奨）
- **スウォッチ間隔**: 8px（推奨）
- **スクロール**: パレットが画面外に出た場合はスクロール対応

### 6.2 選択状態表示

- **選択中の色**: ボーダーで囲む（2px 白色推奨）
- **またはチェックマーク**: 色の上に小さいチェックマークを表示

### 6.3 カラーピッカー

#### 6.3.1 入力フィールド
- **RGB値**: 各成分（R, G, B）を0～255で入力可能なテキストフィールド
- **HEX値**: 6桁の16進数を入力可能
- **リアルタイム更新**: 入力値が変わると即座にプレビューを更新

#### 6.3.2 プレビュー
- **現在の色**: 大きなカラープレビュー表示
- **before/after**: 変更前の色と変更後の色を比較表示（オプション）

### 6.4 カラー管理

#### 6.4.1 削除機能
- ユーザーが追加したカスタムカラーのみ削除可能
- プリセットカラーは削除不可

#### 6.4.2 編集機能
- カスタムカラーの色値を変更可能
- 色の名前を変更可能（表示用）

## 7. データ永続化

### 7.1 glw形式での保存

```json
{
  "mainObject": {
    "voxels": [ /* ... */ ],
    "colors": {
      "voxel_0_face_0": "#FF0000",
      "voxel_0_face_1": "#00FF00",
      "voxel_1_face_2": "#0000FF"
    }
  }
}
```

### 7.2 カラーパレット保存

```json
{
  "colorPalette": [
    {
      "id": "color_red",
      "name": "Red",
      "hex": "#FF0000",
      "rgb": { "r": 255, "g": 0, "b": 0 },
      "custom": false
    },
    {
      "id": "custom_color_0",
      "name": "My Blue",
      "hex": "#0080FF",
      "rgb": { "r": 0, "g": 128, "b": 255 },
      "custom": true
    }
  ]
}
```

### 7.3 ローカルストレージ

ユーザーが追加したカラーはローカルストレージに保存され、アプリケーション再起動後も復元される：

```typescript
// 保存
localStorage.setItem("boxeleditor_color_palette", JSON.stringify(palette));

// 読み込み
const savedPalette = localStorage.getItem("boxeleditor_color_palette");
const palette = savedPalette ? JSON.parse(savedPalette) : defaultPalette;
```

## 8. パフォーマンス

### 8.1 レンダリング最適化

- **マテリアル キャッシング**: 同一色の面は同じマテリアルを共有
- **バッチ処理**: 同一マテリアルの面をまとめて描画

### 8.2 メモリ効率

最大2,500ボクセル × 6面 = 15,000面の着色情報：
- メモリ使用量：約 60KB（色情報のみ）

## 9. アクセシビリティ

### 9.1 カラーコントラスト

- パレット表示時のテキストは WCAG AA 準拠のコントラスト比を確保
- カラーピッカーのラベルは明確に

### 9.2 キーボード操作

- Tab キーでパレット内の色を移動可能
- Enter キーで色を選択可能

## 10. エラーハンドリング

### 10.1 入力値検証

```typescript
function validateRgbValue(value: number): number {
  if (typeof value !== "number") return 0;
  if (value < 0) return 0;
  if (value > 255) return 255;
  return Math.floor(value);
}

function validateHexColor(hex: string): string {
  const cleaned = hex.replace(/^#/, "").toUpperCase();
  if (!/^[0-9A-F]{6}$/.test(cleaned)) {
    return "#808080"; // デフォルト: グレー
  }
  return "#" + cleaned;
}
```

### 10.2 エラーメッセージ

- 無効な入力値の場合、ステータスバーに警告を表示
- 最後に有効だった色値に自動リセット
