# カメラ仕様書

## 1. 概要

Boxel Editorのカメラシステムは、3D空間でのボクセルオブジェクト編集を効率的に行うため、回転、パン、ズーム操作をサポートしています。

## 2. カメラ操作一覧

### 2.1 回転操作（WASD キー）

カメラの視点を回転させます。

| キー | 操作内容 | 実装詳細 |
| --- | --- | --- |
| **W** | 前方方向へ回転（ローカルY軸周り） | カメラのローカル座標系での「上」方向への回転 |
| **S** | 後方方向へ回転（ローカルY軸周り） | カメラのローカル座標系での「下」方向への回転 |
| **A** | グローバルY軸周りで反時計回転 | ワールド座標系のY軸を中心に反時計方向回転 |
| **D** | グローバルY軸周りで時計回転 | ワールド座標系のY軸を中心に時計方向回転 |

**仕様詳細**:
- W/S操作: カメラのローカル座標系における「右」ベクトルを基準として回転を計算
- A/D操作: グローバルY軸（ワールド座標系）を中心に回転
- この組み合わせにより、カメラ向きに関わらず一貫した操作感を実現
- 回転感度は一定に保つ
- 連続した回転操作に対応

### 2.2 パン操作（矢印キー / 十字キー）

カメラの視点を並進移動（パン）させます。

| キー | 操作内容 | 実装詳細 |
| --- | --- | --- |
| **↑（上矢印）** | 上方向パン | カメラのローカル座標系の「上」方向へ移動 |
| **↓（下矢印）** | 下方向パン | カメラのローカル座標系の「下」方向へ移動 |
| **←（左矢印）** | 左方向パン | カメラのローカル座標系の「左」方向へ移動 |
| **→（右矢印）** | 右方向パン | カメラのローカル座標系の「右」方向へ移動 |

**仕様詳細**:
- 上下（↑/↓）: グローバルY軸方向への直接移動（常に垂直）
- 左右（←/→）: カメラのローカル座標系における「右」ベクトルをワールド座標系に変換して移動
- カメラの向きに関わらず、直感的なパン操作が可能
- 移動速度は一定に保つ
- 連続した移動操作に対応

### 2.3 ズーム操作（Q キー）

カメラの視野（FOV）またはカメラ距離を調整し、オブジェクトの拡大・縮小表示を実現します。

| キー組合せ | 操作内容 |
| --- | --- |
| **Q** | 拡大（ズームイン） |
| **Shift + Q** | 縮小（ズームアウト） |

**仕様詳細**:
- 拡大・縮小は段階的に実行される
- ズーム中心はオブジェクト中心（座標(0, 0, 0)）
- ズーム感度は適切に調整される

## 3. カメラパラメータ

### 3.1 座標系

- **原点**: (0, 0, 0)は初期オブジェクトのX-Z平面中心
- **初期オブジェクト底面**: Y = 0 に固定
- **初期カメラ位置**: (0, 0, 20)
- **初期注視点**: (0, gridSize.y/2, 0)

### 3.2 回転の基準

- **W/S回転**: カメラのローカル座標系における「右」ベクトル（applyQuaternionで計算）を基準軸
- **A/D回転**: グローバルY軸（ワールド座標系）を中心に回転
- **回転中心**: 固定（カメラを中心に回転、注視点は相対的に変化）

### 3.3 パンの基準

- **上下パン（↑/↓）**: グローバルY軸方向への直接移動
- **左右パン（←/→）**: カメラのローカル座標系の「右」ベクトルをワールド座標系に変換して移動
- **実装方式**: Quaternionを使用した座標変換により、カメラ向きに依存しない直感的操作を実現

## 4. パフォーマンス

- カメラ操作は60FPS以上のフレームレートを維持
- 複数キー同時押しに対応

## 5. ファイル保存時のカメラ状態

- カメラ状態（位置、回転角度など）は glw/gltf形式ファイルに記録される可能性あり（※ ファイルI/O実装状況に依存）
- ※ 現在の実装ではカメラ状態のファイル保存・復元はまだ実装されていない

## 6. アンドゥ・リドゥ機能

- ※ カメラ操作は現在のアンドゥ・リドゥ履歴に記録されていない
- 将来の実装により、カメラ操作の履歴管理に対応予定

## 7. 技術的実装

### 7.1 使用ライブラリ

- **Three.js 0.182.0**: PerspectiveCamera オブジェクト管理、Quaternion によるローカル座標変換
- **TypeScript**: イベントハンドリング実装、CameraController クラスで一元管理

### 7.2 イベントハンドリング

キー入力は以下の優先度で処理される：
1. キーダウンイベントでキー状態を記録
2. キーアップイベントでキー状態をクリア
3. アニメーションフレーム内でアクティブなキーから操作を実行

### 7.3 ローカル座標系対応の実装

- **右ベクトル計算**: `rightVector.applyQuaternion(camera.quaternion)` で、グローバルX軸 (1,0,0) をカメラのクォータニオン変換
- **W/S操作**: 計算した右ベクトルを回転軸として使用
- **パン操作**: ワールドY軸 (0,1,0) のままで上下パン、右ベクトルで左右パン
- **クォータニオン**: カメラの向き情報を Quaternion として保持し、正確な座標変換を実現
