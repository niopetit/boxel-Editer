# アンドゥ・リドゥ仕様書

## 1. 概要

Boxel Editorのアンドゥ・リドゥシステムは、ユーザーの操作を履歴として記録し、前の状態または次の状態に復元できます。

**実装状況**: 基本的なフレームワークは構築されていますが、現在記録されている操作は以下に限定されています：
- ボクセルの追加・削除
- 面の着色

**未実装**: カメラ操作の履歴記録

## 2. 基本仕様

### 2.1 操作キーバインド

| プラットフォーム | アンドゥ | リドゥ |
| --- | --- | --- |
| **Mac** | Command + Z | Command + Shift + Z |
| **Windows/Linux** | Ctrl + Z | Ctrl + Shift + Z |

### 2.2 スタック管理

```
アンドゥスタック：最新の操作ほど上に積まれる
┌─────────────────┐
│  Action 5       │ ← トップ（最新）
├─────────────────┤
│  Action 4       │
├─────────────────┤
│  Action 3       │
├─────────────────┤
│  Action 2       │
├─────────────────┤
│  Action 1       │
└─────────────────┘

リドゥスタック：アンドゥで戻した操作を格納
┌─────────────────┐
│  Action 5       │ ← トップ
├─────────────────┤
│  Action 6       │
└─────────────────┘
```

### 2.3 ポインタ管理

```typescript
interface UndoRedoManager {
  undoStack: Action[];
  redoStack: Action[];
  currentIndex: number;
  maxStackSize: number = 1000;  // 最大1000操作を履歴保持
}
```

## 3. アクションの定義

### 3.1 アクション構造

```typescript
interface Action {
  id: string;                          // ユニークID
  type: ActionType;                    // 操作のタイプ
  timestamp: string;                   // ISO 8601形式
  description: string;                 // 人間が読める説明（UI表示用）
  data: ActionData;                    // 操作固有のデータ
  targetObject: "main" | "adjacent";   // メインまたは隣接オブジェクト
}

type ActionType = 
  | "addVoxel"
  | "deleteVoxel"
  | "colorFace"
  | "cameraMove"
  | "cameraRotate"
  | "cameraZoom";

interface ActionData {
  [key: string]: any;  // 操作タイプに応じて異なる
}
```

### 3.2 各アクションの詳細

#### 3.2.1 ボクセル追加（addVoxel）

```typescript
interface AddVoxelAction extends Action {
  type: "addVoxel";
  data: {
    voxelId: string;
    position: Vector3;
    faceId: string;   // 追加時に選択されていたボクセルの面
  };
}
```

**復元方法**:
#### 3.2.2 ボクセル削除（deleteVoxel）

```typescript
interface DeleteVoxelAction extends Action {
  type: "deleteVoxel";
  data: {
    voxelId: string;
    position: Vector3;
    voxelData: VoxelSnapshot;  // 削除前のボクセルデータ（復元用）
  };
}
```

**復元方法**:
- Undo: ボクセルを復元
- Redo: ボクセルを再度削除

**実装状況**: ✅ 完全実装

#### 3.2.3 面着色（colorFace）

```typescript
interface ColorFaceAction extends Action {
  type: "colorFace";
  data: {
    faceId: string;
    voxelId: string;
    previousColor: string;    // 変更前の色
    newColor: string;         // 変更後の色
  };
}
```

**復元方法**:
- Undo: 面を前の色に戻す
- Redo: 面を新しい色に変更

**実装状況**: ✅ 完全実装

#### 3.2.4 カメラ操作（未実装）

カメラ操作（移動、回転、ズーム）の履歴記録は将来実装予定です。

現在、以下のカメラ操作は記録されていません：
- cameraMove（カメラ移動）
- cameraRotate（カメラ回転）
- cameraZoom（カメラズーム）

**実装予定**: 今後のバージョンで対応予定

## 4. 操作履歴の記録

### 4.1 アクション記録タイミング

#### 4.1.1 即座に記録される操作

- ボクセルの追加（左クリック後、Shift+右クリック時）
- ボクセルの削除（Command/Alt+右クリック時）
- 面の着色（Option+右クリック時）

#### 4.1.2 グループ化される操作（複合アクション）

複数のキー入力が短時間に行われた場合、1つのアクションにグループ化：

```typescript
// 例: カメラを複数フレーム回転
// → 回転開始から回転終了までを1つの "cameraRotate" アクションにまとめる

interface CompoundAction extends Action {
  type: "compound";
  actions: Action[];  // 複数のアクションを格納
}
```

#### 4.1.3 カメラ操作の記録

**オプション A: 毎フレーム記録**
```typescript
function recordCameraState() {
  if (cameraPositionChanged || cameraRotationChanged) {
    pushAction({
      type: "cameraMove" or "cameraRotate",
      // ...
    });
  }
}
```

**オプション B: キー入力終了時に記録（推奨）**
```typescript
function onCameraKeyUp() {
  if (cameraStateChanged) {
    pushAction({
      type: "compound",
      actions: [/* 変更した状態をまとめる */]
    });
  }
}
```

要件定義書では「カメラ操作を記録する」と記載されているため、**オプション B（終了時記録）** を推奨。

### 4.2 アクション追加処理

```typescript
function pushAction(action: Action): void {
  // リドゥスタックをクリア（新しい操作が行われたため）
  redoStack = [];
  
  // アンドゥスタックに追加
  undoStack.push(action);
  
  // スタックサイズ上限を超えた場合、古い操作を削除
  if (undoStack.length > MAX_STACK_SIZE) {
    undoStack.shift();  // 最も古い操作を削除
  }
  
  // UI更新（アンドゥ/リドゥボタンの有効/無効状態）
  updateUndoRedoUI();
}
```

## 5. アンドゥ・リドゥ処理

### 5.1 アンドゥ処理

```typescript
function undo(): void {
  if (undoStack.length === 0) {
    showWarning("アンドゥできる操作がありません");
    return;
  }
  
  const action = undoStack.pop();
  
  // 現在の状態をリドゥスタックに保存
  // （新しい状態ではなく、復元前の状態を保存）
  const reverseAction = createReverseAction(action, currentState);
  redoStack.push(reverseAction);
  
  // アクション固有の復元処理
  applyReverseAction(action);
  
  // 3D描画を更新
  render();
  
  // UI更新
  updateUndoRedoUI();
}

function applyReverseAction(action: Action): void {
  switch (action.type) {
    case "addVoxel":
      // 追加したボクセルを削除
      deleteVoxel(action.data.voxelId);
      break;
    
    case "deleteVoxel":
      // 削除したボクセルを復元
      restoreVoxel(action.data.voxelData);
      break;
    
    case "colorFace":
      // 面の色を前の色に戻す
      colorFace(action.data.faceId, action.data.previousColor);
      break;
    
    case "cameraMove":
      // カメラを前の位置に戻す
      camera.position.copy(action.data.previousPosition);
      break;
    
    case "cameraRotate":
      // カメラを前の回転に戻す
      camera.quaternion.copy(action.data.previousRotation);
      break;
    
    case "cameraZoom":
      // カメラをズーム前の状態に戻す
      camera.zoom = action.data.previousZoom;
      camera.updateProjectionMatrix();
      break;
  }
}
```

### 5.2 リドゥ処理

```typescript
function redo(): void {
  if (redoStack.length === 0) {
    showWarning("リドゥできる操作がありません");
    return;
  }
  
  const action = redoStack.pop();
  
  // 現在の状態をアンドゥスタックに保存
  const reverseAction = createReverseAction(action, currentState);
  undoStack.push(reverseAction);
  
  // アクション実行
  applyAction(action);
  
  // 3D描画を更新
  render();
  
  // UI更新
  updateUndoRedoUI();
}

function applyAction(action: Action): void {
  switch (action.type) {
    case "addVoxel":
      // ボクセルを追加
      addVoxelAtPosition(action.data.position);
      break;
    
    case "deleteVoxel":
      // ボクセルを削除
      deleteVoxel(action.data.voxelId);
      break;
    
    case "colorFace":
      // 面に新しい色を設定
      colorFace(action.data.faceId, action.data.newColor);
      break;
    
    // カメラ操作も同様
  }
}
```

## 6. UIとの連携

### 6.1 メニューバー表示

```
編集メニュー:
├─ アンドゥ (Cmd+Z)      [有効/無効]
└─ リドゥ (Cmd+Shift+Z)  [有効/無効]
```

### 6.2 ボタンの有効/無効制御

```typescript
function updateUndoRedoUI(): void {
  // アンドゥボタン
  const undoButton = document.getElementById("undo-btn");
  undoButton.disabled = undoStack.length === 0;
  undoButton.title = undoStack.length > 0 
    ? `アンドゥ: ${undoStack[undoStack.length - 1].description}`
    : "アンドゥできる操作がありません";
  
  // リドゥボタン
  const redoButton = document.getElementById("redo-btn");
  redoButton.disabled = redoStack.length === 0;
  redoButton.title = redoStack.length > 0 
    ? `リドゥ: ${redoStack[redoStack.length - 1].description}`
    : "リドゥできる操作がありません";
}
```

### 6.3 操作の説明文

各アクションの `description` フィールドで、ユーザーフレンドリーな説明を提供：

| アクション | description |
| --- | --- |
| addVoxel | "ボクセルを追加" |
| deleteVoxel | "ボクセルを削除" |
| colorFace | "面を着色（#RRGGBB）" |
| cameraMove | "カメラを移動" |
| cameraRotate | "カメラを回転" |
| cameraZoom | "カメラをズーム" |

## 7. ファイル保存時の履歴管理

### 7.1 glw形式での保存

操作履歴はglw形式ファイルに保存される：

```json
{
  "undoRedoHistory": [
    {
      "id": "action_0",
      "type": "addVoxel",
      "timestamp": "2024-01-11T10:30:00Z",
      "description": "ボクセルを追加",
      "targetObject": "main",
      "data": { /* ... */ }
    },
    {
      "id": "action_1",
      "type": "colorFace",
      "timestamp": "2024-01-11T10:30:05Z",
      "description": "面を着色（#FF0000）",
      "targetObject": "main",
      "data": { /* ... */ }
    }
  ]
}
```

### 7.2 読み込み時の復元

ファイルから読み込む際、操作履歴を復元：

```typescript
function loadProjectFile(filePath: string): void {
  const data = JSON.parse(fs.readFileSync(filePath, "utf-8"));
  
  // メインオブジェクトとデータを復元
  loadMainObject(data.mainObject);
  loadAdjacentObjects(data.adjacentObjects);
  
  // 操作履歴を復元（ただし、表示のみ）
  undoStack = data.undoRedoHistory || [];
  redoStack = [];  // リドゥスタックはクリア
  
  // UIを更新
  updateUndoRedoUI();
}
```

## 8. パフォーマンス最適化

### 8.1 メモリ効率

**スタックサイズ上限**: 1000操作

```
メモリ計算例:
- 1つのアクション: 約 1KB（平均）
- 1000操作: 約 1MB
- 合計メモリ: 許容範囲内
```

### 8.2 スナップショット管理

ボクセル削除時は、復元用にボクセルデータ全体をスナップショットとして保存：

```typescript
// 最適化: 大きなボクセルメッシュの場合、圧縮を検討
// JSON.stringify → zlib.compress など
```

## 9. エラーハンドリング

### 9.1 不可逆操作への対応

削除されたボクセルのスナップショットが失われた場合：

```typescript
if (!action.data.voxelData) {
  showError("このアクションは復元できません。別のバージョンから復元してください。");
  return;
}
```

### 9.2 スタック破損時

```typescript
function validateStack(): boolean {
  // スタック内のアクションIDが重複していないかチェック
  const ids = new Set();
  for (const action of undoStack) {
    if (ids.has(action.id)) {
      console.error("スタックが破損しています");
      return false;
    }
    ids.add(action.id);
  }
  return true;
}
```

## 10. テスト戦略

### 10.1 単体テスト

- 各アクション（add, delete, color）の undo/redo
- スタックのサイズ管理
- キーバインドの動作

### 10.2 統合テスト

- 複合操作のアンドゥ・リドゥ（例: 複数ボクセルを追加してから削除）
- ファイル保存・読み込み時の履歴復元
- メモリリークの確認（大量操作後）
